<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
      #myCanvas {
        transform: scale(1);
        transform-origin: 0 0;
      }
      .canvas-wrapper {
        padding: 5px;
      }
      .color-button {
        display: inline;
        padding: 15px;
        margin: 10px;
        background-color: #ff0;
        border: 1px solid transparent;
      }
      .color-button:hover {
        cursor: pointer;
        border: 1px solid blue;
      }
    </style>
    <script src="js/Sound.js"></script>
    <script src="js/MainLoop.js"></script>
    <script src="js/tinycolor/tinycolor.js"></script>
    <script src="js/pulsar.js"></script>
  </head>

  <body>
    <div class='canvas-wrapper'>
      <canvas id="myCanvas" width="1200" height="800"></canvas>
    </div>
    <!-- <canvas id="myCanvas" width="6000" height="4000"></canvas> -->
    <div id="fpsDisplay" style="position: absolute; top: 70px; left: 10px;"></div>
    <img id="canvasCopy" style="width:50px; height:50px; border: 1px solid gray;" onclick="copyCanvas()">

    <script>
      // prozac green:  Graphic Designers Pantone: 2253 C,   Hex: #bde9c9,   RGB: rgb(189, 233, 201)
      var canvas = document.getElementById('myCanvas');
      var context = canvas.getContext('2d');
      var centerX = canvas.width / 3;
      var centerY = canvas.height / 3;
      var radius = 200;

      var pulsarConfigs = [
        {
          context: context,
          colorFactory: new ColorFactory({color: [51, 153, 0, 0.2]}),
          x: 200,
          y: 100,
        },
        {
          context: context,
          colorFactory: new ColorFactory({color: [255, 153, 0, 0.2]}),
          x: 400,
          y: 200,
          velocity: .03,
        },
        {
          context: context,
          colorFactory: new ColorFactory({color: [255, 0, 0, 0.06667]}),
          x: 300,
          y: 300,
          velocity: .02,
        },
        {
          context: context,
          colorFactory: new ColorFactory({color: [0, 0, 102, 0.1333]}),
          x: 450,
          y: 300,
          velocity: .025,
          maxR: 200,
        },
        {
          context: context,
          colorFactory: new ColorFactory({color: [255, 153, 0, 0.8]}),
          x: 450,
          y: 300,
          velocity: .018,
          maxR: 200,
        },
        {
          context: context,
          colorFactory: new ColorFactory({color: [0, 153, 102, 0.9333]}),
          x: 450,
          y: 300,
          velocity: .018,
          maxR: 200,
        }
      ];

      var currentPen = pulsarConfigs[0];

      function copyCanvas() {
        var dataURL = canvas.toDataURL();
        document.getElementById('canvasCopy').src = dataURL;
      }

      clearCanvas('yellow');

      window.cnv = canvas;

      var cfBlue = new ColorFactory({colorFrom: [80,255,255,0.92], colorTo: [100,80,160,0.2]});
      var fpsDisplay = document.getElementById('fpsDisplay');
      var b1 = {
        color: '#ffff0022',
        boxPos: 100,
        boxLastPos: 100,
        boxVelocity: 0.02,
        limit: 500,
      }
      var b2 = {
        color: '#00660033',
        boxPos: 120,
        boxLastPos: 120,
        boxVelocity: 0.025,
        limit: 500,
      }
      var timestep = 1000 / 30;

      var loopLog = [];
      var frameCount = 0;

      function update(delta) {
        loopLog && loopLog.push({
          frameCount,
          delta,
        });
        frameCount++;
        if (loopLog && frameCount > 120) {
          console.log(JSON.stringify(loopLog, null, 4));
          loopLog = null;
        }

        // b1.boxLastPos = b1.boxPos;
        // b1.boxPos += b1.boxVelocity * delta;
        // if (b1.boxPos >= b1.limit || b1.boxPos <= 100) b1.boxVelocity = -b1.boxVelocity;

        // b2.boxLastPos = b2.boxPos;
        // b2.boxPos += b2.boxVelocity * delta;
        // if (b2.boxPos >= b2.limit || b2.boxPos <= 100) b2.boxVelocity = -b2.boxVelocity;

        updateAll(delta);
      }

      function draw(interp) {
        loopLog && loopLog.push({
          frameCount,
          interp,
        });
        // drawCircle(context, (b1.boxLastPos + (b1.boxPos - b1.boxLastPos) * interp), centerY+100, radius, b1.color);
        // drawCircle(context, 2*(b2.boxLastPos + (b2.boxPos - b2.boxLastPos) * interp), centerY+100, radius, b2.color);
        drawAll(interp);
        fpsDisplay.textContent = Math.round(MainLoop.getFPS()) + ' FPS';
      }

      function updateAll(delta) {
        pulsars.forEach(function (p) {
          p.update(delta);
        });
      }

      function drawAll(interp) {
        pulsars.forEach(function (p) {
          p.draw(interp);
        });
      }

      function handleClick(x, y) {
        var scale = 1 / 1;   // 1 over canvas scale factor
        var _class = {Pulsar, PulsarSolid, Slider}[currentPen.type || 'Pulsar'];
        currentPen.x = x;
        currentPen.y = y;
        currentPen.context = context;
        pulsars.push(new _class(currentPen));
      }

      var pulsars = [];

      pulsars.push(new Pulsar({
        context: context,
        colorFactory: new ColorFactory({color: [51, 153, 0, 0.2]}),
        x: 200,
        y: 100,
      }));

      pulsars.push(new Pulsar({
        context: context,
        colorFactory: new ColorFactory({color: [255, 153, 0, 0.2]}),
        x: 400,
        y: 200,
        velocity: .03,
      }));

      pulsars.push(new Pulsar({
        context: context,
        colorFactory: new ColorFactory({color: [255, 0, 0, 0.06667]}),
        x: 300,
        y: 300,
        velocity: .02,
      }));

      pulsars.push(new Pulsar({
        context: context,
        colorFactory: new ColorFactory({color: [102, 0, 255, 0.2]}),
        x: 500,
        y: 200,
        velocity: .018,
      }));

      pulsars.push(new Pulsar({
        context: context,
        colorFactory: new ColorFactory({color: [0, 153, 102, 0.9333]}),
        x: 450,
        y: 300,
        velocity: .025,
      }));

      pulsars.push(new Pulsar({
        context: context,
        colorFactory: new ColorFactory({color: [0, 0, 102, 0.1333]}),
        x: 550,
        y: 200,
        velocity: .001,
      }));

      pulsars.push(new Pulsar({
        context: context,
        colorFactory: new ColorFactory({color: [51, 153, 0, 0.2]}),
        x: 200,
        y: 100,
        maxR: 200,
      }));

      pulsars.push(new Pulsar({
        context: context,
        colorFactory: new ColorFactory({color: [255, 153, 0, 0.8]}),
        x: 400,
        y: 200,
        velocity: .05,
        maxR: 50,
      }));

      pulsars.push(new Pulsar({
        context: context,
        colorFactory: new ColorFactory({color: [255, 0, 0, 0.0667]}),
        x: 300,
        y: 300,
        velocity: .02,
        maxR: 200,
      }));

      pulsars.push(new Pulsar({
        context: context,
        colorFactory: new ColorFactory({color: [102, 0, 255, 0.2]}),
        x: 500,
        y: 200,
        velocity: .018,
        maxR: 200,
      }));

      pulsars.push(new Pulsar({
        context: context,
        colorFactory: new ColorFactory({color: [0, 153, 102, 0.9333]}),
        x: 450,
        y: 300,
        velocity: .025,
        maxR: 200,
      }));

      pulsars.push(new PulsarSolid({
        context: context,
        colorFactory: new ColorFactory({color: [255, 0, 102, 0.1333]}),
        x: 650,
        y: 200,
        velocity: .002,
        maxR: 80,
      }));

      pulsars.push(new Slider({
        context: context,
        colorFactory: new ColorFactory({color: [0, 0, 102, 0.1333]}),
        x: 550,
        y: 200,
        velocity: .3,
        maxX: 900,
        r: radius,
      }));

      pulsars.push(new Slider({
        context: context,
        colorFactory: new ColorFactory({color: [0, 153, 102, 0.6]}),
        x: 150,
        y: 200,
        maxX: 800,
        r: radius,
        velocity: .1,
      }));

      MainLoop.setSimulationTimestep(timestep);
      MainLoop.setDraw(draw);
      MainLoop.setUpdate(update);
      MainLoop.start();

      canvas.addEventListener('click', function (e) {
        handleClick(e.pageX, e.pageY);
      })
      canvas.addEventListener('touchstart', function (e) {
        handleClick(e.pageX, e.pageY);
      })

      addButtons(pulsarConfigs);
      //============================================================

      function rgbHex(rgbaArray) {
        return tinycolor({r:rgbaArray[0], g:rgbaArray[1], b:rgbaArray[2], a:1.0}).toHex8String();
      }

      function setPen(pulsarConfig) {
        console.log('setPen()', pulsarConfig);
        currentPen = pulsarConfig;
      }

      function addButtons(configs) {
        configs.forEach(function (config) {
          var div = document.createElement('div');
          div.className = ('color-button');
          div.style.backgroundColor = rgbHex(config.colorFactory.getColor());
          div.addEventListener('click', (function (c) {
                      return function (e) { setPen(c); };
                    })(config));
          document.body.append(div);
        })
      }

    </script>
  </body>
</html>
