<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
      #myCanvas {
        transform: scale(1);
        transform-origin: 0 0;
      }
    </style>
    <script src="js/Sound.js"></script>
    <script src="js/MainLoop.js"></script>
    <script src="js/tinycolor/tinycolor.js"></script>
  </head>

  <body>
    <canvas id="myCanvas" width="1200" height="800"></canvas>
    <!-- <canvas id="myCanvas" width="6000" height="4000"></canvas> -->
    <div id="fpsDisplay" style="position: absolute; top: 70px; left: 10px;"></div>
    <img id="canvasCopy" style="width:50px; height:50px; border: 1px solid gray;" onclick="copyCanvas()">

    <script>
      // prozac green:  Graphic Designers Pantone: 2253 C,   Hex: #bde9c9,   RGB: rgb(189, 233, 201)
      var canvas = document.getElementById('myCanvas');
      var context = canvas.getContext('2d');
      var centerX = canvas.width / 3;
      var centerY = canvas.height / 3;
      var radius = 200;

      function copyCanvas() {
        var dataURL = canvas.toDataURL();
        document.getElementById('canvasCopy').src = dataURL;
      }

      function drawCircle(context, x, y, r, color) {
        r = (r < 0) ? 0 : r;
        context.beginPath();
        context.arc(x, y, r, 0, 2 * Math.PI, false);
        context.fillStyle = '#00000000';
        context.fill();
        context.lineWidth = 2;
        context.strokeStyle = color;
        context.stroke();
      }

      function drawCircleFilled(context, x, y, r, color) {
        r = (r < 0) ? 0 : r;
        context.beginPath();
        context.arc(x, y, r, 0, 2 * Math.PI, false);
        context.fillStyle = color;
        context.fill();
        context.lineWidth = 2;
        context.strokeStyle = color;
        context.stroke();
      }

      context.rect(0, 0, canvas.width, canvas.height);
      context.fillStyle = 'yellow';
      context.fill();

      context.beginPath();
      context.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
      context.fillStyle = 'green';
      context.fill();
      context.lineWidth = 2;
      context.strokeStyle = '#003300bb';
      context.stroke();

      context.beginPath();
      context.arc(centerX-50, centerY+50, radius, 0, 2 * Math.PI, false);
      context.fillStyle = '#660000bb';
      context.fill();
      context.lineWidth = 2;
      context.strokeStyle = '#006600bb';
      context.stroke();

      window.cnv = canvas;

      //============================================================
      class ColorFactory {
        //80,255,255, 100,80,160, 255
        constructor(props = {cFrom: [0,0,0,1], cTo: [255,255,255,1]}) {
          this.colorFrom = props.cFrom.slice(0);
          this.colorTo = props.cTo.slice(0);
        }

        getColor(position = 1) { // 0-1
          var newColor = [];
          newColor[0] = this.colorFrom[0] + Math.round((this.colorTo[0]-this.colorFrom[0]) * position);
          newColor[1] = this.colorFrom[1] + Math.round((this.colorTo[1]-this.colorFrom[1]) * position);
          newColor[2] = this.colorFrom[2] + Math.round((this.colorTo[2]-this.colorFrom[2]) * position);
          newColor[3] = this.colorFrom[3] + ((this.colorTo[3]-this.colorFrom[3]) * position);
          return newColor;
        }
      }

      var cfBlue = new ColorFactory({cFrom: [80,255,255,0.92], cTo: [100,80,160,0.2]});

      class Pulsar {
        constructor(props = {}) {
          this.color = props.color || '#ffff0022';
          this.context = props.context;
          this.x = props.x || 0;
          this.y = props.y || 0;
          this.r = props.r || 0;
          this.lastr = props.r || 0;
          this.maxR = props.maxR || 250;
          this.velocity = props.velocity || 0.02;
        }

        update(delta) {
          this.lastr = this.r;
          this.r += this.velocity * delta;
          if (this.r >= this.maxR || this.r <= 0) {
            this.velocity = -this.velocity;
          }
        }

        draw(interp) {
          var color = cfBlue.getColor(this.r / this.maxR);
          var hex = tinycolor({r:color[0], g:color[1], b:color[2], a:color[3]}).toHex8String();
          drawCircle(
            this.context,
            this.x,
            this.y,
            (this.lastr + (this.r - this.lastr) * interp),
            this.color
            // hex
          );
        }
      }

      class PulsarSolid extends Pulsar {
        draw(interp) {
          drawCircleFilled(
            this.context,
            this.x,
            this.y,
            (this.lastr + (this.r - this.lastr) * interp),
            this.color
          );
        }
      }

      class Slider {
        constructor(props = {}) {
          this.color = props.color || '#ffff0022';
          this.context = props.context;
          this.x = props.x || 0;
          this.y = props.y || 0;
          this.r = props.r || 100;
          this.lastx = props.x || 0;
          this.minX = props.x || 0;
          this.maxX = props.maxX || 500;
          this.velocity = props.velocity || 0.02;
        }

        update(delta) {
          this.lastx = this.x;
          this.x += this.velocity * delta;
          if (this.x >= this.maxX || this.x <= this.minX) {
            this.velocity = -this.velocity;
          }
        }

        draw(interp) {
          drawCircle(
            this.context,
            (this.lastx + (this.x - this.lastx) * interp),
            this.y,
            this.r,
            this.color
          );
        }
      }

      var fpsDisplay = document.getElementById('fpsDisplay');
      var b1 = {
        color: '#ffff0022',
        boxPos: 100,
        boxLastPos: 100,
        boxVelocity: 0.02,
        limit: 500,        
      }
      var b2 = {
        color: '#00660033',
        boxPos: 120,
        boxLastPos: 120,
        boxVelocity: 0.025,
        limit: 500,        
      }
      var timestep = 1000 / 30;

      function update(delta) {
          b1.boxLastPos = b1.boxPos;
          b1.boxPos += b1.boxVelocity * delta;
          if (b1.boxPos >= b1.limit || b1.boxPos <= 100) b1.boxVelocity = -b1.boxVelocity;

          b2.boxLastPos = b2.boxPos;
          b2.boxPos += b2.boxVelocity * delta;
          if (b2.boxPos >= b2.limit || b2.boxPos <= 100) b2.boxVelocity = -b2.boxVelocity;

          updateAll(delta);
          // P1.update(delta);
          // P2.update(delta);
      }

      function draw(interp) {
          drawCircle(context, (b1.boxLastPos + (b1.boxPos - b1.boxLastPos) * interp), centerY+100, radius, b1.color);
          drawCircle(context, 2*(b2.boxLastPos + (b2.boxPos - b2.boxLastPos) * interp), centerY+100, radius, b2.color);
          drawAll(interp);
          // P1.draw(interp);
          // P2.draw(interp);
          fpsDisplay.textContent = Math.round(MainLoop.getFPS()) + ' FPS';
      }

      function updateAll(delta) {
        pulsars.forEach(function (p) {
          p.update(delta);
        });
      }

      function drawAll(interp) {
        pulsars.forEach(function (p) {
          p.draw(interp);
        });
      }

      function handleClick(x, y) {
        console.log(x,y);
        var scale = 1 / 1;   // 1 over canvas scale factor
        pulsars.push(new Pulsar({
          context: context,
          color: '#33990033',
          x: x * scale, 
          y: y * scale,
        }));
      }

      var pulsars = [];

      pulsars.push(new Pulsar({
        context: context,
        color: '#33990033',
        x: 200,
        y: 100,
      }));

      pulsars.push(new Pulsar({
        context: context,
        color: '#ff990033',
        x: 400,
        y: 200,
        velocity: .03,
      }));

      pulsars.push(new Pulsar({
        context: context,
        color: '#ff000011',
        x: 300,
        y: 300,
        velocity: .02,
      }));

      pulsars.push(new Pulsar({
        context: context,
        color: '#6600ff33',
        x: 500,
        y: 200,
        velocity: .018,
      }));

      pulsars.push(new Pulsar({
        context: context,
        color: '#009966ee',
        x: 450,
        y: 300,
        velocity: .025,
      }));

      pulsars.push(new Pulsar({
        context: context,
        color: '#00006622',
        x: 550,
        y: 200,
        velocity: .001,
      }));

      pulsars.push(new Pulsar({
        context: context,
        color: '#33990033',
        x: 200,
        y: 100,
        maxR: 200,
      }));

      pulsars.push(new Pulsar({
        context: context,
        color: '#ff9900cc',
        x: 400,
        y: 200,
        velocity: .05,
        maxR: 50,
      }));

      pulsars.push(new Pulsar({
        context: context,
        color: '#ff000011',
        x: 300,
        y: 300,
        velocity: .02,
        maxR: 200,
      }));

      pulsars.push(new Pulsar({
        context: context,
        color: '#6600ff33',
        x: 500,
        y: 200,
        velocity: .018,
        maxR: 200,
      }));

      pulsars.push(new Pulsar({
        context: context,
        color: '#009966ee',
        x: 450,
        y: 300,
        velocity: .025,
        maxR: 200,
      }));

      pulsars.push(new PulsarSolid({
        context: context,
        color: '#ff006622',
        x: 650,
        y: 200,
        velocity: .002,
        maxR: 80,
      }));

      pulsars.push(new Slider({
        context: context,
        color: '#00006622',
        x: 550,
        y: 200,
        velocity: .001,
        maxX: 900,
        r: radius,
      }));

      pulsars.push(new Slider({
        context: context,
        color: '#00996699',
        x: 150,
        y: 200,
        maxX: 800,
        r: radius,
        velocity: .1,
      }));


      MainLoop.setSimulationTimestep(timestep);
      MainLoop.setDraw(draw);
      MainLoop.setUpdate(update);
      MainLoop.start();

      canvas.addEventListener('click', function (e) {
        handleClick(e.pageX, e.pageY);
      })
      canvas.addEventListener('touchstart', function (e) {
        handleClick(e.pageX, e.pageY);
      })
      //============================================================

    </script>
  </body>
</html>
