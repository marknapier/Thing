<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Patterns Demo</title>
    <link href="reset.css" rel="stylesheet">
    <style>
    </style>
  </head>

  <body>

<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> -->
<!-- <script src='jquery/jquery-1.9.1.js'></script> -->
<script src='jquery/jquery.min.js'></script>
<script src='thing.js'></script>
<script src='sylvester/sylvester.js'></script>

<script type="text/javascript">
var greens = ['#339911', '#008000', '#009000', '#008600', '#00aa00', '#008010', '#108000', '#30a000', '#00a030', '#30a030'];
var sofaSizes = [5, 10, 12.5, 16.6, 25, 50];

function scaleDocument (n) {
  var el = document.body;
  el.style.transformOrigin = 'left top';
  el.style.transform = 'scale(' + n + ')';
}

function makePattern (name, size) {
  var Rand = Thing.classes.Rand;
  var Pattern = Thing.classes.Pattern;
  var P = Pattern.make({pattern: name});
  var box = Thing.classes.Box.make( {
    x: Rand.randInt(0,3000),
    y: 0,
    w: Rand.randInt(400,1600),
    h: 3600,
    z: Rand.randInt(1,1000) * 10,
    backgroundColor: Rand.randItem(greens),
    position: 'absolute',
    display: 'block',
    overflow: 'hidden'
  });

  if (size) {
    P.css({backgroundSize: size + '%'});
  }

  box.add( P )
  return box;
}

function makeTextPane (x, y, w, h) {
  var Rand = Thing.classes.Rand;
  var TextPane = Thing.classes.TextPane;
  var bgColor = Rand.randItem(greens);
  var textBox = Thing.classes.Box.make({
      x: x,
      y: y,
      w: w,
      h: h,
      overflow: 'hidden',
      backgroundColor: bgColor
  });
  var fontSize = Rand.randInt(36, 160);

  textBox.add( TextPane.make({
      text:'There was a man and a dog too this time. Two beasts, counting Old Ben, the bear, and two men, counting Boon and Hoggenbeck, in whom some of the same blood ran which ran in Sam Fathers, even though Boon\'s was a plebeian strain of it and only Sam and Old Ben and the mongrel Lion were taintless and incorruptible.',
      width:'100%',
      height:'100%',
      color: Rand.randRGBstr(),
      fontSize: fontSize
  }) );
  textBox.add( TextPane.make({
      text:'That put the thing in a new light. Ben stopped nibbling his apple. Tom swept his brush daintily back and forth -- stepped back to note the effect -- added a touch here and there -- criticised the effect again -- Ben watching every move and getting more and more interested, more and more absorbed. Presently he said:',
      width:'100%',
      height:'100%',
      color: '#f0fff9',
      fontSize: fontSize
  }) );
  textBox.add( TextPane.make({
      text:'On the surface, I was calm: in secret, without really admitting it, I was waiting for something. Her return? How could I have been waiting for that? We all know that we are material creatures, subject to the laws of physiology and physics, and not even the power of all our feelings combined can defeat those laws. All we can do is detest them. The age-old faith of lovers and poets in the power of love, stronger than death, that finis vitae sed non amoris, is a lie, useless and not even funny. So must one be resigned to being a clock that measures the passage of time, now out of order, now repaired, and whose mechanism generates despair and love as soon as its maker sets it going? Are we to grow used to the idea that every man relives ancient torments, which are all the more profound because they grow comic with repetition? That human existence should repeat itself, well and good, but that it should repeat itself like a hackneyed tune, or a record a drunkard keeps playing as he feeds coins into the jukebox...',
      width:'100%',
      height:'100%',
      color: bgColor,
      fontSize: fontSize
  }).rotate(90) );
  return textBox;
}

function makeMenina() {
  var Rand = Thing.classes.Rand;
  var i = Thing.classes.Img
    .make({
      src:'img/las_meninas_girl_t.png',
      x: Rand.randInt(-500, 4500),
      y: Rand.randInt(500, 2000),
      z: Rand.randInt(500,1000) * 10
    })
    .scaleTo(.8 + (Rand.randFloat()*2))
    .rotate(Rand.randInt(180)-90)  ;
  return i;
}

function makeCouch() {
  var Rand = Thing.classes.Rand;
  var i = Thing.classes.Img
    .make({
      src:'img/sofa_3_victorian_sofa_t.png',    //sofa_leather_overstuffed_t.png
      x: 600,
      y: 1600,
      z: Rand.randInt(9000, 10000),
      filter: 'drop-shadow(10px 10px 19px rgba(0,0,0,0.7))'
    })
    .scaleTo(1.8) ;
  return i;
}

function makeFloor () {
  var i = Thing.classes.Img
    .make({
      src:'img/wood_texture_smooth_panel_red_oak.jpg',
      w: 1000,
      h: 600,
      z: 20000
    })
    .css({transform: 'translate(0px, 780px) rotateX(90deg) scale(2)'})  ;
  return i;
}

// function makeRightWall () {
//   var i = Thing.classes.Img
//     .make({
//       src:'img/vintagewallpaper4_crop_edges_1.png',   // 'vintagewallpaper4_crop.png',
//       w: 1000,
//       h: 1000,
//       z: 1000,
//       opacity: .1
//     })
//     .css({transform: 'translate(800px, -60px) rotateY(110deg) scale(2)'})  ;
//   return i;
// }

function makeRightWall () {
  var i = Thing.classes.Img
    .make({
      src: 'img/vintagewallpaper4_crop.png',   //'img/vintagewallpaper4_crop_cutout_1.png',
      w: 2000,
      h: 2000,
      z: 5000,
      opacity: .85
    })
    .css({
      transform: 'translate(2500px, 0px) rotateY(110deg) scale(2)'
    });

  var g = Thing.make({
      w: 2000,
      h: 2000,
      opacity: 1
    })
    .css({
      background: 'radial-gradient(at 40% 30%, rgba(255, 224, 113, 0.490196) 10%, transparent 50%, rgba(144, 0, 27, 0.8) 90%)'
    });

  i.$element.append(g.$element);
  return i;
}

function makeBubbleArrow (bubbleX, bubbleY, targetX, targetY, color, text, shorten, z) {
  z = z || 2200;

  var l = Thing.classes.Line.make({
    x1:bubbleX, y1:bubbleY,
    x2:targetX, y2:targetY,
    color: color,
    width:10,
    arrow:true,
    shorten: shorten,
    zIndex: z,
    boxShadow: '0px 0px 9px -1px rgba(10,20,0,0.75)'
  });

  var c = Thing.classes.Circle.make({
    text: text || '' + Thing.classes.Rand.randInt(1, 67),
    x: bubbleX,
    y: bubbleY,
    r: 100,
    zIndex: z+1,
    fontSize: '64px',
    color: '#fff',
    boxShadow: '0px 0px 9px 0px rgba(10,20,0,0.75)',
    borderColor: color,
    borderWidth: 10
  })

  return [l,c];
}

function makeTextArrow (bubbleX, bubbleY, targetX, targetY, color, text, shorten, z) {
  z = z || 2200;

  var r = 30;

  var l = Thing.classes.Line.make({
    x1:bubbleX, y1:bubbleY,
    x2:targetX, y2:targetY,
    color: color,
    width:4,
    arrow:true,
    shorten: shorten,
    zIndex: z,
    boxShadow: '0px 0px 1px 0px rgba(0,0,0,0.25)'
  });

  var c = Thing.classes.Label.make({
    text: text || '' + Thing.classes.Rand.randInt(1, 67),
    x: bubbleX - r,
    y: bubbleY - (82),  //fontSize
    // w: r*2,
    zIndex: z+1,
    fontSize: '82px',
    color: '#0f0',
    // borderBottom: '3px solid #0f0',
    textShadow: '1px 1px 3px rgba(0,0,0,0.2)'
  })

  return [l,c];
}

function makeBackground (w, h, scale) {
  return Thing.classes.Box
      .make({
        w: w,
        h: h,
        backgroundColor: '#ff6400',
        position: 'absolute',
        display: 'block',
        overflow: 'hidden',
        perspective: '4000px',
        transformStyle: 'preserve-3d'
      })
      .render();
}

function makeStage (w, h, scale) {
  return Thing.classes.Box
      .make({
        w: w,
        h: h,
        backgroundColor: '#ff64cc',
        position: 'absolute',
        display: 'block',
        overflow: 'hidden',
        perspective: '2000px',
        transformStyle: 'preserve-3d'
      })
      .render();
}

//----------------------------------------------------
// Matrix functions (rely on Sylvester.js)

// return a Sylvester.js matrix from an array of 6 values
function makeMatrix2D (mA) {
  var m = null;
  if (mA && mA.length === 6) {
    var m = $M([
      [mA[0], mA[2], mA[4]],
      [mA[1], mA[3], mA[5]],
      [0,0,1]
    ]);
  }
  return m;
}

// return the point transformed by the given matrix
// CSS Elements by default have transform-origin at center. Pass
// the position of the origin in originOffset (defaults to 0,0).
function transformPoint (point, M, originOffset) {
  originOffset = originOffset || [0,0];
  // shift point to center around origin
  var v = Vector.create([point[0]-originOffset[0], point[1]-originOffset[1], 1]);
  // transform the point
  var tm = M.multiply(v);
  // shift the transformed point back
  var tx = tm.elements[0]+originOffset[0];
  var ty = tm.elements[1]+originOffset[1];
  return [tx, ty];
}

//----------------------------------------------------
// 1.35  (.74)     6000x4440    5130x3800
// 1.3888  (.72)   6000x4320    5000x3600  4000x2880
// 1.4084 (.71)      6000x4260
// 1.618   (.618)     6000x3708.3
//

$(function () {
  var Rand = Thing.classes.Rand;
  var Img = Thing.classes.Img;
  var TextPane = Thing.classes.TextPane;

  // setup the stage
  var aspectRatio = .72;
  var pixelWidth = 5000;
  var pixelHeight = pixelWidth * aspectRatio;
  var mainScale = pixelWidth * .001;  // assume design is 1000 pixels wide, this will be 1
  var background = makeBackground(pixelWidth, pixelHeight, mainScale);
  var stage = makeStage(pixelWidth, pixelHeight, mainScale);

  // background aliasing is smoother at a larger size
  // scaleDocument(3);

  // Prevents the screenshot plugin from including scrollbars in large screenshots.
  $('body').css({
    overflow: 'hidden',
    transformOrigin: '0 0'
  });

  background.add(makeTextPane(0, 0, 1200, 2500));

  background.add(makePattern('GraphPaper'));
  background.add(makePattern('PlaidRed'));
  background.add(makePattern('Sofa', Rand.randItem(sofaSizes)));
  background.add(makePattern('PolkaDotsLarge'));
  background.add(makePattern('StripesOchre', Rand.randInt(3,20)));
  background.add(makePattern('DiagonalStripesViolet', Rand.randInt(5,20)));

  var menina = makeMenina();
  menina.css({border: '9px solid rgba(255, 192, 203, 1)'});
  background.add(makeMenina());
  background.add(menina);

  window.menina = menina;
  window.BG = background;

  background.add(makeCouch());

  background.add(makeRightWall());
  // background.add(makeFloor())

  // Room edge right side
  var edge = Thing.classes.Line.make({
    x1:4150, y1:0,
    x2:4150, y2:3000,
    width: 20,
    zIndex: 10010,
    background: 'linear-gradient(rgb(0, 40, 80) 0%, rgb(255, 128, 0) 100%)'
  });
  background.add(edge);

  background.add( makeBubbleArrow(
          Rand.randInt(100,1000), Rand.randInt(50,400),
          menina.x, menina.y,
          '#ceff34', '', false, Rand.randInt(3000,15000)) );

  var pos = menina.getPosition();

  // Room
  // var R = Thing.classes.Room.make({
  //   w: pixelWidth,
  //   h: pixelHeight,
  //   d: 2000
  // });
  // R.walls.back.add(background);

  // var floorImg = Thing.classes.Img
  //   .make({
  //     src:'img/wood_texture_smooth_panel_red_oak.jpg',
  //     w: pixelWidth,
  //     h: 2000
  //   });
  // R.walls.bottom.add(floorImg);

  // stage.add(R);

  // makeFloor
  var floorImg = Thing.classes.Img
    .make({
      src:'img/wood_texture_smooth_panel_red_oak_pers_left.png',
      right: '0px',
      bottom: '0px',
      w: pixelWidth,
      h: 1000,
      zIndex: 20000
    });
  background.add(floorImg);

  stage.add(background);
  stage.render();


  function makeImgPointers () {
    var dim = menina.getDimensions();
    var point = [500, 100];
    var M = makeMatrix2D( menina.getCSSTransform() );
    var tp = transformPoint (point, M, [dim.w/2, dim.h/2]);
    background.add( makeTextArrow(
      Rand.randInt(tp[0]-100, tp[0]+100), Rand.randInt(tp[1]-150, tp[1]-350),
      tp[0], tp[1],
      '#5dff1d', parseInt(tp[0]), 60, pos[2]+5000) );
    background.render();
  }

  Thing.classes.Img.onAllLoaded = makeImgPointers;

  // background: linear-gradient( 45deg, red 0%, red 50%, white 51%, white 100% );
  // radial-gradient(ellipse at 40% 30%, rgba(255, 255, 0, 0.13) 20%, transparent 60%, rgba(249, 0, 0, .2) 90%),
  // $('#Img22').css('transform').replace(/[^0-9\-.,]/g, '').split(',')
  // clip-path: inset(0px 120px 646px 0px);
  //perspective-origin: 50% 25%
  //backface-visibility: hidden
});
</script>


  </body>
</html>
